<!-- Clean Delivery Layout - No Triple Problems -->
<div class="delivery-layout" [class.loading]="isLoading">

  <!-- Accessibility Skip Link -->
  <a class="skip-link" href="#main-content">Skip to main content</a>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading" role="status" aria-label="Loading dashboard">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading your dashboard...</p>
    </div>
  </div>

  <!-- Top Navigation (Desktop Only) -->
  <app-navigation-bar
    *ngIf="isDesktop"
    [currentLayout]="currentLayout"
    [showLayoutSwitcher]="true"
    [navigationItems]="navigationItems"
    [isAuthenticated]="isAuthenticated"
    [currentUser]="currentUser">
  </app-navigation-bar>

  <!-- Main Container -->
  <div class="container">

    <!-- Mobile Header -->
    <header class="mobile-header" *ngIf="!isDesktop">
      <div class="header-content">
        <!-- Mobile Top Bar -->
        <div class="mobile-top-bar">
          <div class="logo-section">
            <span class="logo-icon">🚚</span>
            <span class="logo-text">Delivery</span>
          </div>
          <div class="header-actions">
            <div class="layout-switcher-mobile">
              <button (click)="switchToCustomerLayout()" class="layout-btn" title="Customer View">🍽️</button>
              <button (click)="switchToAdminLayout()" class="layout-btn" title="Admin View">⚙️</button>
              <button class="layout-btn active" title="Delivery View">🚚</button>
            </div>
            <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
              <span class="icon" [class.spinning]="isLoading">🔄</span>
            </button>
          </div>
        </div>

        <div class="greeting">
          <h1 class="greeting-text">{{ getGreeting() }}, {{ currentUser?.firstName || 'Driver' }}!</h1>
        </div>

        <div class="status-section">
          <button class="status-toggle"
                  [class.online]="isOnline"
                  [class.offline]="!isOnline"
                  (click)="toggleOnlineStatus()"
                  [disabled]="isLoading">
            <span class="status-dot" [class.pulse]="isOnline"></span>
            <span class="status-text">{{ isOnline ? 'Online' : 'Offline' }}</span>
          </button>

          <div class="location" [class.error]="locationError">
            <span class="location-icon">📍</span>
            <span class="location-text">{{ currentLocation }}</span>
            <button class="location-refresh" (click)="refreshLocation()">🔄</button>
          </div>
        </div>

        <div class="notifications" *ngIf="getUnreadNotificationCount() > 0">
          <div class="notification-badge">
            <span class="icon">🔔</span>
            <span class="count">{{ getUnreadNotificationCount() }}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Layout Grid -->
    <div class="layout-grid">

      <!-- Sidebar (Desktop Only) -->
      <aside class="sidebar" *ngIf="isDesktop">
        <div class="sidebar-content">
          <div class="driver-info">
            <h2 class="greeting">{{ getGreeting() }}, {{ currentUser?.firstName || 'Driver' }}!</h2>
            <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
              <span class="icon" [class.spinning]="isLoading">🔄</span>
            </button>
          </div>

          <div class="status-card">
            <button class="status-toggle large"
                    [class.online]="isOnline"
                    [class.offline]="!isOnline"
                    (click)="toggleOnlineStatus()"
                    [disabled]="isLoading">
              <span class="status-dot" [class.pulse]="isOnline"></span>
              <div class="status-info">
                <span class="status-text">{{ isOnline ? 'Online' : 'Offline' }}</span>
                <span class="status-subtitle">{{ isOnline ? 'Ready for orders' : 'Not accepting orders' }}</span>
              </div>
            </button>
          </div>

          <div class="location-card" [class.error]="locationError">
            <div class="location-content">
              <span class="location-icon">📍</span>
              <div class="location-info">
                <span class="location-text">{{ currentLocation }}</span>
                <span class="location-error" *ngIf="locationError">{{ locationError }}</span>
              </div>
              <button class="location-refresh" (click)="refreshLocation()">🔄</button>
            </div>
          </div>

          <div class="quick-actions">
            <h3 class="section-title">Quick Actions</h3>
            <div class="actions-list">
              <button *ngFor="let action of quickActions"
                      class="action-btn"
                      [class]="action.color"
                      [class.disabled]="!isOnline && action.route.includes('orders')"
                      (click)="navigateToAction(action.route)">
                <span class="action-icon">{{ action.icon }}</span>
                <span class="action-label">{{ action.label }}</span>
                <span class="action-badge" *ngIf="action.label === 'My Orders' && stats.pendingOrders > 0">
                  {{ stats.pendingOrders }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content" id="main-content">

        <!-- Stats Dashboard -->
        <section class="stats-section">
          <h2 class="section-title">Today's Performance</h2>
          <div class="stats-grid">

            <div class="stat-card primary" [class.urgent]="stats.pendingOrders > 5">
              <div class="stat-header">
                <span class="stat-icon">📦</span>
                <span class="urgent-indicator" *ngIf="stats.pendingOrders > 5">!</span>
              </div>
              <div class="stat-body">
                <div class="stat-value">{{ stats.pendingOrders }}</div>
                <div class="stat-label">Pending Orders</div>
              </div>
            </div>

            <div class="stat-card success">
              <div class="stat-header">
                <span class="stat-icon">✅</span>
              </div>
              <div class="stat-body">
                <div class="stat-value">{{ stats.completedToday }}</div>
                <div class="stat-label">Completed Today</div>
              </div>
            </div>

            <div class="stat-card warning">
              <div class="stat-header">
                <span class="stat-icon">💰</span>
              </div>
              <div class="stat-body">
                <div class="stat-value">{{ formatCurrency(stats.earnings) }}</div>
                <div class="stat-label">Today's Earnings</div>
              </div>
            </div>

            <div class="stat-card info">
              <div class="stat-header">
                <span class="stat-icon">⭐</span>
              </div>
              <div class="stat-body">
                <div class="stat-value">{{ stats.rating.toFixed(1) }}</div>
                <div class="stat-label">Your Rating</div>
              </div>
            </div>

          </div>
        </section>

        <!-- Quick Actions (Mobile Only) - Simplified -->
        <section class="mobile-actions" *ngIf="!isDesktop && stats.pendingOrders > 0">
          <div class="urgent-actions">
            <button class="urgent-action-btn" (click)="navigateToAction('/delivery/orders')">
              <span class="urgent-icon">📦</span>
              <span class="urgent-text">{{ stats.pendingOrders }} Pending Orders</span>
              <span class="urgent-arrow">→</span>
            </button>
          </div>
        </section>

        <!-- Recent Orders -->
        <section class="orders-section" *ngIf="orders.length > 0">
          <div class="section-header">
            <h2 class="section-title">Recent Orders</h2>
            <button class="view-all-btn" (click)="navigateToAction('/delivery/orders')">
              View All
            </button>
          </div>

          <div class="orders-list">
            <div *ngFor="let order of orders.slice(0, 3)"
                 class="order-card"
                 [class]="'status-' + order.status.toLowerCase()">

              <div class="order-header">
                <div class="order-info">
                  <span class="order-id">#{{ order.orderId }}</span>
                  <span class="customer-name">{{ order.customerName }}</span>
                </div>
                <div class="order-status">
                  <span class="status-icon">{{ getOrderStatusIcon(order.status) }}</span>
                  <span class="status-text">{{ order.status }}</span>
                </div>
              </div>

              <div class="order-details">
                <div class="order-address">
                  <span class="address-icon">📍</span>
                  <span class="address-text">{{ order.address }}</span>
                </div>
                <div class="order-meta">
                  <span class="restaurant" *ngIf="order.restaurantName">{{ order.restaurantName }}</span>
                  <span class="amount" *ngIf="order.totalAmount">{{ formatCurrency(order.totalAmount) }}</span>
                </div>
              </div>

              <div class="order-actions" *ngIf="order.status === 'ReadyForPickup' || order.status === 'PickedUp'">
                <button class="action-btn primary"
                        *ngIf="order.status === 'ReadyForPickup'"
                        (click)="updateOrderStatus(order.orderId, 'PickedUp')">
                  Mark as Picked Up
                </button>
                <button class="action-btn success"
                        *ngIf="order.status === 'PickedUp'"
                        (click)="updateOrderStatus(order.orderId, 'Delivered')">
                  Mark as Delivered
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Empty State -->
        <section class="empty-state" *ngIf="!isLoading && orders.length === 0">
          <div class="empty-content">
            <div class="empty-icon">📦</div>
            <h3 class="empty-title">No orders yet</h3>
            <p class="empty-message">
              {{ isOnline ? 'You\'re online and ready to receive orders!' : 'Go online to start receiving orders' }}
            </p>
            <button *ngIf="!isOnline" class="btn primary" (click)="toggleOnlineStatus()">
              Go Online
            </button>
          </div>
        </section>

        <!-- Router Outlet -->
        <section class="dynamic-content">
          <router-outlet></router-outlet>
        </section>

      </main>
    </div>
  </div>

  <!-- Bottom Navigation (Mobile Only) -->
  <nav class="bottom-nav" *ngIf="!isDesktop">
    <a routerLink="/delivery/orders" routerLinkActive="active" class="nav-item">
      <span class="nav-icon">📦</span>
      <span class="nav-label">Orders</span>
      <span class="nav-badge" *ngIf="stats.pendingOrders > 0">{{ stats.pendingOrders }}</span>
    </a>
    <a routerLink="/delivery/navigation" routerLinkActive="active" class="nav-item">
      <span class="nav-icon">🗺️</span>
      <span class="nav-label">Navigate</span>
    </a>
    <a routerLink="/delivery/dashboard" routerLinkActive="active" class="nav-item">
      <span class="nav-icon">🏠</span>
      <span class="nav-label">Home</span>
    </a>
    <a routerLink="/delivery/earnings" routerLinkActive="active" class="nav-item">
      <span class="nav-icon">💰</span>
      <span class="nav-label">Earnings</span>
    </a>
    <a routerLink="/delivery/profile" routerLinkActive="active" class="nav-item">
      <span class="nav-icon">👤</span>
      <span class="nav-label">Profile</span>
    </a>
  </nav>

  <!-- Emergency Button -->
  <button class="emergency-btn" (click)="callSupport()">
    <span class="emergency-icon">📞</span>
    <span class="emergency-text">Support</span>
  </button>

</div>
